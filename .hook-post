#!/bin/bash

onexit() {
    echo "Skip package install"
    exit 1
}

install_brew() {
    if ! hash brew 2>/dev/null; then
        ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"
    fi
}

install_cask() {
    install_brew
    brew tap phinze/cask
    brew install brew-cask
}

trap onexit 1 2 3 15 ERR

echo "Install basic packages? [git, tmux, vim, autojump, curl, wget]"
select yn in "Yes" "No"; do
    case $yn in
        Yes )
            if [ "$UNAME" == "Darwin" ]; then
                install_brew
                brew install autojump tmux reattach-to-user-namespace htop wget bash bash-completion w3m
                sudo ln -sf /usr/local/bin/tmux /usr/bin
                sudo ln -sf /usr/local/bin/reattach-to-user-namespace /usr/bin
                install_cask
                brew cask install macvim slate
            else
                sudo apt-get install autojump tmux vim htop git curl wget bash bash-completion w3m
                sudo apt-get install --no-install-recommends
            fi
            break;;
        No )
            break;;
    esac
done

if [ -e "$HOME/.vimbundle.vim" ] && hash vim 2>/dev/null && hash git 2>/dev/null; then
    echo "Install vim plugins (requires git and vim)?"
    select yn in "Yes" "No"; do
        case $yn in
            Yes )
                VUNDLE_GIT="https://github.com/gmarik/vundle.git"
                VUNDLE_DIR="$HOME/.vim/bundle/vundle"
                if [ ! -e "$VUNDLE_DIR" ]; then
                    git clone $VUNDLE_GIT $VUNDLE_DIR
                fi
                vim -u "$HOME/.vimbundle.vim" +PluginInstall! +PluginClean +qall;
                break;;
            No ) break;;
        esac
    done
fi

echo "Install extra packages? [chrome, dropbox, gimp, vlc, latex]"
select yn in "Yes" "No"; do
    case $yn in
        Yes )
            if [ "$UNAME" == "Darwin" ]; then
                install_cask
                brew cask install google-chrome google-hangouts dropbox gimp vlc basictex
                echo Inkscape must be installed manually.
            else
                apt-get install google-chrome latex-beamer inkscape gimp vlc texlive-latex-extra
                echo Dropbox and google-talk plugin must be installed manually.
            fi
            break;;
        No )
            break;;
    esac
done

echo "Configure git?"
select yn in "Yes" "No"; do
    case $yn in
        Yes )
            echo -n "Full name: "
            read fullname
            git config --global user.name "$fullname"
            echo -n "Email: "
            read email
            git config --global user.email $email
            break;;
        No )
            break;;
    esac
done

echo "Copy ssh keys and config?"
select yn in "Yes" "No"; do
    case $yn in
        Yes )
            echo -n "Server name: "
            read server
            mkdir -p ~/.ssh
            scp $server:".ssh/id_* .ssh/config" ~/.ssh
            break;;
        No )
            break;;
    esac
done
