#!/bin/bash
declare -A patterns
patterns['(https?://[^[:space:]:]+)']='\1'
patterns['(ftp://[^[:space:]:]+)']='\1'
patterns['(go/[[:alnum:]_-]+)']='\1'
patterns['(b/[0-9]+)']='\1'
patterns['(cl/[0-9]+)']='\1'
patterns['(cr/[0-9]+)']='\1'
patterns['(depot/[^[:space:]]+)']='cs.corp.google.com/piper///\1'
patterns['(/cns/[^ \*]+)']='cnsviewer.corp.google.com\1'

input=-

if [ $# -ge 1 -a -f "$1" ]; then
  input="$1"
fi

IFS='|' eval 'matchall=${!patterns[*]}'
matches=$(cat $input | grep -oE "$matchall" | uniq)
if [ -z "$matches" ]; then
  exit 0
fi

match=$(echo "$matches" | fzf --tac --header 'Ctrl-X to copy to clipboard' --bind "ctrl-x:execute:(echo {} | ccopy)")
if [ -n "$match" ]; then
  for pattern in "${!patterns[@]}"; do
    if echo "$match" | grep -E "$pattern" >/dev/null 2>&1; then
      url=$(echo $match | sed -r "s#.*${pattern}.*#${patterns[$pattern]}#")
      echo -n "Opening $url in $BROWSER... "
      $BROWSER $url >/dev/null 2>&1
      echo "done."
      exit 0
    fi
  done
  echo "fatal error!"
  exit 1
fi
